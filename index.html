<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™êµ ë°˜í¸ì„± ë°ì´í„° ê´€ë¦¬ ë„êµ¬ v3.6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 20px; background-color: #f4f7f8; color: #333; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
        
        /* ì„¤ì • ì˜ì—­ */
        .config-box { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; }
        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .config-item { display: flex; flex-direction: column; }
        .config-item label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .config-item input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; background-color: #fff; }
        .config-item input.auto-detected { border-color: #34a853; background-color: #e6f4ea; }

        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ êµ¬ì—­ */
        #dropZone { border: 2px dashed #1a73e8; border-radius: 12px; padding: 40px; text-align: center; background-color: #f0f7ff; color: #1a73e8; cursor: pointer; transition: 0.3s; margin-bottom: 20px; font-weight: bold; }
        #dropZone.dragover { background-color: #d1e3ff; border-color: #0d47a1; transform: scale(1.01); }
        #dropZone p { margin: 0; font-size: 16px; }
        #dropZone span { font-size: 13px; color: #666; font-weight: normal; }

        /* ë²„íŠ¼ ë° ìƒíƒœ ì˜ì—­ */
        .btn-area { border-top: 1px solid #eee; padding-top: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-blue { background-color: #1a73e8; }
        .btn-green { background-color: #34a853; }
        .btn-red { background-color: #ea4335; }
        button:hover { opacity: 0.8; }
        #status { font-weight: bold; font-size: 0.9em; width: 100%; margin-top: 10px; color:#666; }

        /* íƒ­ ì˜ì—­ */
        .tabs { display: flex; margin-top: 25px; border-bottom: 2px solid #dee2e6; }
        .tab { padding: 10px 25px; cursor: pointer; background: #e9ecef; border-radius: 8px 8px 0 0; margin-right: 5px; border: 1px solid #dee2e6; border-bottom: none; }
        .tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -2px; color: #1a73e8; font-weight: bold; }
        
        .tab-content { display: none; background: white; border: 1px solid #dee2e6; border-top: none; height: 450px; overflow: auto; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 13px; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #dee2e6; }
        tr:hover { background-color: #f1f3f4; }
        .empty-msg { text-align: center; padding: 50px; color: #999; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ« ë°˜í¸ì„± ë°ì´í„° ê´€ë¦¬ ë„êµ¬ (v3.6)</h2>

    <div id="dropZone" onclick="document.getElementById('filePicker').click()">
        <p>íŒŒì¼ì„ ì´ êµ¬ì—­ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
        <span>(ì´ì „/ì§„ê¸‰ í—¤ë” ê·œì • ìë™ íŒë³„ ì§€ì›)</span>
    </div>

    <!-- ì¶”ì¶œ ì—´ ì„¤ì • ì˜ì—­ -->
    <div class="config-box">
        <div style="margin-bottom:10px; font-size:13px; color:#1a73e8; font-weight:bold;">âš™ï¸ ì¶”ì¶œ ì—´ ì„¤ì • (A=0, B=1...) - ëª¨ë“œì— ë”°ë¼ ìë™ ê°ì§€</div>
        <div class="config-grid">
            <div class="config-item"><label>ì„±ëª…</label><input type="number" id="idx_name" value="3" oninput="reprocess()"></div>
            <div class="config-item"><label>ì´ì „í•™ë…„</label><input type="number" id="idx_p_g" value="12" oninput="reprocess()"></div>
            <div class="config-item"><label>ì´ì „ë°˜</label><input type="number" id="idx_p_c" value="13" oninput="reprocess()"></div>
            <div class="config-item"><label>í˜„ì¬í•™ë…„</label><input type="number" id="idx_c_g" value="0" oninput="reprocess()"></div>
            <div class="config-item"><label>í˜„ì¬ë°˜</label><input type="number" id="idx_c_c" value="1" oninput="reprocess()"></div>
            <div class="config-item"><label>í˜„ì¬ë²ˆí˜¸</label><input type="number" id="idx_c_n" value="2" oninput="reprocess()"></div>
        </div>
    </div>

    <div class="btn-area">
        <input type="file" id="filePicker" accept=".csv, .xlsx, .xls" style="display:none;">
        <button class="btn-red" onclick="resetAll()">ë°ì´í„° ì´ˆê¸°í™”</button>
        <button class="btn-green" style="margin-left: auto;" onclick="exportToCSV()">ê²°ê³¼ ì €ì¥í•˜ê¸° (CSV)</button>
        <div id="status">íŒŒì¼ì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div class="tabs">
        <div id="tab1" class="tab active" onclick="switchTab(1)">ì •ìƒ ë°ì´í„°</div>
        <div id="tab2" class="tab" onclick="switchTab(2)">ì˜ˆì™¸ ë°ì´í„° (ê²°ì¸¡ì¹˜)</div>
    </div>

    <div id="view1" class="tab-content active">
        <table id="tableValid">
            <thead><tr><th>ì„±ëª…</th><th>ì´ì „í•™ë…„</th><th>ì´ì „ë°˜</th><th>í˜„ì¬í•™ë…„</th><th>í˜„ì¬ë°˜</th><th>í˜„ì¬ë²ˆí˜¸</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="view2" class="tab-content">
        <table id="tableException">
            <thead><tr><th>ì„±ëª…</th><th>ì´ì „í•™ë…„</th><th>ì´ì „ë°˜</th><th>í˜„ì¬í•™ë…„</th><th>í˜„ì¬ë°˜</th><th>í˜„ì¬ë²ˆí˜¸</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let originalRawData = []; 
    let finalValid = [];
    let finalException = [];

    const dropZone = document.getElementById('dropZone');
    const filePicker = document.getElementById('filePicker');

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
    ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.add('dragover')));
    ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));
    dropZone.addEventListener('drop', e => { if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files[0]); });
    filePicker.addEventListener('change', e => { if (e.target.files.length) handleFiles(e.target.files[0]); });

    function handleFiles(file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            try {
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                originalRawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ""});
                autoDetectMapping(originalRawData);
                processData(originalRawData);
            } catch (err) { alert("íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- ì •ë³´ ì²˜ë¦¬ ê·œì • v3.6 í•µì‹¬ ë¡œì§ ---
    function autoDetectMapping(rows) {
        let headerRowIdx = -1;
        let mode = ""; // "ì´ì „" ë˜ëŠ” "ì§„ê¸‰"

        // 1. í—¤ë” í–‰(Aì—´ì´ 'í•™ë…„') ì°¾ê¸° ë° ëª¨ë“œ íŒë³„
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i].map(c => String(c).trim());
            if (row[0] === "í•™ë…„") {
                headerRowIdx = i;
                const fullRowText = row.join("|");
                if (fullRowText.includes("ì´ì „")) mode = "ì´ì „";
                else if (fullRowText.includes("ì§„ê¸‰")) mode = "ì§„ê¸‰";
                break;
            }
        }

        if (headerRowIdx === -1) return;

        const headerRow = rows[headerRowIdx].map(c => String(c).trim());
        
        // ê³µí†µ: ì„±ëª… ìœ„ì¹˜ ì°¾ê¸°
        const nameIdx = headerRow.indexOf("ì„±ëª…");
        if (nameIdx !== -1) document.getElementById('idx_name').value = nameIdx;

        if (mode === "ì´ì „" || mode === "") {
            // [ê·œì • 1: ì´ì „ ë‹¨ì–´ í¬í•¨ ì‹œ] í˜„ì¬ ì •ë³´ë¥¼ ë©”ì¸ í—¤ë”ì—ì„œ ì¶”ì¶œ
            const cgIdx = headerRow.indexOf("í•™ë…„");
            const ccIdx = headerRow.indexOf("ë°˜");
            const cnIdx = headerRow.indexOf("ë²ˆí˜¸");
            if (cgIdx !== -1) document.getElementById('idx_c_g').value = cgIdx;
            if (ccIdx !== -1) document.getElementById('idx_c_c').value = ccIdx;
            if (cnIdx !== -1) document.getElementById('idx_c_n').value = cnIdx;

            // ì´ì „ ì •ë³´ëŠ” ë¹„ì–´ìˆëŠ” Aì—´ í–‰ì—ì„œ ì¶”ì¶œ
            for (let i = 0; i < rows.length; i++) {
                const r = rows[i].map(c => String(c).trim());
                if (r[0] === "") {
                    if (r.includes("í•™ë…„")) document.getElementById('idx_p_g').value = r.indexOf("í•™ë…„");
                    if (r.includes("ë°˜")) document.getElementById('idx_p_c').value = r.indexOf("ë°˜");
                }
            }
        } else if (mode === "ì§„ê¸‰") {
            // [ê·œì • 2: ì§„ê¸‰ ë‹¨ì–´ í¬í•¨ ì‹œ] ì´ì „ ì •ë³´ë¥¼ ë©”ì¸ í—¤ë”ì—ì„œ ì¶”ì¶œ
            const pgIdx = headerRow.indexOf("í•™ë…„");
            const pcIdx = headerRow.indexOf("ë°˜");
            if (pgIdx !== -1) document.getElementById('idx_p_g').value = pgIdx;
            if (pcIdx !== -1) document.getElementById('idx_p_c').value = pcIdx;

            // í˜„ì¬ ì •ë³´ëŠ” ë¹„ì–´ìˆëŠ” Aì—´ í–‰ì—ì„œ ì¶”ì¶œ
            for (let i = 0; i < rows.length; i++) {
                const r = rows[i].map(c => String(c).trim());
                if (r[0] === "") {
                    if (r.includes("í•™ë…„")) document.getElementById('idx_c_g').value = r.indexOf("í•™ë…„");
                    if (r.includes("ë°˜")) document.getElementById('idx_c_c').value = r.indexOf("ë°˜");
                    if (r.includes("ë²ˆí˜¸")) document.getElementById('idx_c_n').value = r.indexOf("ë²ˆí˜¸");
                }
            }
        }

        document.querySelectorAll('.config-item input').forEach(el => el.classList.add('auto-detected'));
        const statusMsg = mode ? `[${mode} ëª¨ë“œ] í—¤ë”ë¥¼ ê°ì§€í•˜ì—¬ ì—´ ë²ˆí˜¸ë¥¼ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.` : "í—¤ë”ë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤.";
        document.getElementById('status').innerHTML = `<span style="color:#1a73e8">${statusMsg}</span>`;
    }

    function reprocess() { if (originalRawData.length > 0) processData(originalRawData); }

    function processData(allRows) {
        finalValid = []; finalException = [];
        const mapping = {
            name: parseInt(document.getElementById('idx_name').value),
            p_g:  parseInt(document.getElementById('idx_p_g').value),
            p_c:  parseInt(document.getElementById('idx_p_c').value),
            c_g:  parseInt(document.getElementById('idx_c_g').value),
            c_c:  parseInt(document.getElementById('idx_c_c').value),
            c_n:  parseInt(document.getElementById('idx_c_n').value)
        };

        allRows.forEach(row => {
            const cleanRow = row.map(cell => cell !== null && cell !== undefined ? String(cell).trim() : "");
            // í•™ìƒ ë°ì´í„° íŒë‹¨ ê¸°ì¤€: ì‚¬ìš©ìê°€ ì„¤ì •í•œ 'í˜„ì¬í•™ë…„' ì—´ì— 'í•™ë…„' í…ìŠ¤íŠ¸ í¬í•¨ í–‰
            if (cleanRow[mapping.c_g] && cleanRow[mapping.c_g].includes("í•™ë…„") && cleanRow[mapping.c_g] !== "í•™ë…„") {
                let currentNum = cleanRow[mapping.c_n];
                if (currentNum === "0" || currentNum === "0.0") currentNum = "";
                const extracted = [cleanRow[mapping.name], cleanRow[mapping.p_g], cleanRow[mapping.p_c], cleanRow[mapping.c_g], cleanRow[mapping.c_c], currentNum];
                const isInvalid = [extracted[0], extracted[1], extracted[2], extracted[3], extracted[4]].some(v => v === "" || v.toLowerCase() === "nan");
                if (isInvalid) finalException.push(extracted);
                else finalValid.push(extracted);
            }
        });
        renderUI();
    }

    function resetAll() {
        if (!confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        originalRawData = []; finalValid = []; finalException = [];
        filePicker.value = ""; document.getElementById('status').innerHTML = "íŒŒì¼ì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...";
        document.querySelectorAll('.config-item input').forEach(el => el.classList.remove('auto-detected'));
        renderUI();
    }

    function renderUI() {
        fillTable('tableValid', finalValid); fillTable('tableException', finalException);
        if (originalRawData.length > 0) document.getElementById('status').innerHTML += ` | ë¶„ì„ ê²°ê³¼: ì •ìƒ <b>${finalValid.length}</b>ê±´ / ì˜ˆì™¸ <b>${finalException.length}</b>ê±´`;
    }

    function fillTable(id, data) {
        const tbody = document.getElementById(id).querySelector('tbody');
        tbody.innerHTML = data.length === 0 ? '<tr><td colspan="6" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : "";
        data.forEach(rowData => {
            const tr = document.createElement('tr');
            rowData.forEach(text => { const td = document.createElement('td'); td.innerText = text; tr.appendChild(td); });
            tbody.appendChild(tr);
        });
    }

    function switchTab(idx) {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab' + idx).classList.add('active');
        document.getElementById('view' + idx).classList.add('active');
    }

    function exportToCSV() {
        if (finalValid.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const header = ["ì„±ëª…", "í•™ë…„", "ë°˜", "í•™ë…„", "ë°˜", "ë²ˆí˜¸"];
        const rows = [header, ...finalValid];
        const csvString = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\r\n");
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "ë°˜í¸ì„±ê²°ê³¼.csv";
        link.click();
    }
</script>

</body>
</html>