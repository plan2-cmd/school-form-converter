<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™êµ ë°˜í¸ì„± ë°ì´í„° ê´€ë¦¬ ë„êµ¬ v4.5</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; margin: 20px; background-color: #f4f7f8; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #1a73e8; margin-bottom: 20px; }
        
        .config-box { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 8px; margin-bottom: 20px; }
        .mode-area { display: flex; gap: 20px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px dashed #ccc; align-items: center; }
        .mode-label { font-weight: bold; color: #555; margin-right: 10px; }
        .radio-label { display: flex; align-items: center; cursor: pointer; font-size: 14px; font-weight: bold; }
        .radio-label input { margin-right: 5px; cursor: pointer; width: 16px; height: 16px; accent-color: #1a73e8; }

        .config-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
        .config-item { display: flex; flex-direction: column; }
        .config-item label { font-size: 12px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .config-item input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; background-color: #fff; }
        .config-item input.auto-detected { border-color: #34a853; background-color: #e6f4ea; }
        .config-item input.default-applied { border-color: #fbbc04; background-color: #fff8e1; }

        #dropZone { border: 2px dashed #1a73e8; border-radius: 12px; padding: 40px; text-align: center; background-color: #f0f7ff; color: #1a73e8; cursor: pointer; transition: 0.3s; margin-bottom: 20px; font-weight: bold; }
        #dropZone.dragover { background-color: #d1e3ff; border-color: #0d47a1; transform: scale(1.01); }

        .btn-area { border-top: 1px solid #eee; padding-top: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        button { padding: 12px 20px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-blue { background-color: #1a73e8; }
        .btn-green { background-color: #34a853; }
        .btn-red { background-color: #ea4335; }
        button:hover { opacity: 0.8; }
        #status { font-weight: bold; font-size: 0.9em; width: 100%; margin-top: 10px; color:#666; }

        .tabs { display: flex; margin-top: 25px; border-bottom: 2px solid #dee2e6; }
        .tab { padding: 10px 20px; cursor: pointer; background: #e9ecef; border-radius: 8px 8px 0 0; margin-right: 5px; border: 1px solid #dee2e6; border-bottom: none; font-size: 14px; }
        .tab.active { background: white; border-bottom: 2px solid white; margin-bottom: -2px; color: #1a73e8; font-weight: bold; }
        
        .tab-content { display: none; background: white; border: 1px solid #dee2e6; border-top: none; height: 500px; overflow: auto; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; min-width: 900px; font-size: 13px; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: center; white-space: nowrap; }
        th { background: #f8f9fa; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #dee2e6; }
        tr:hover { background-color: #f1f3f4; }
        .empty-msg { text-align: center; padding: 50px; color: #999; }

        /* ì›ë³¸ ë°ì´í„° í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        #tableRaw th { background-color: #e8f0fe; color: #174ea6; font-size: 12px; }
        #tableRaw td:first-child { background-color: #f1f3f4; font-weight: bold; color: #555; position: sticky; left: 0; z-index: 5; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ« ë°˜í¸ì„± ë°ì´í„° ê´€ë¦¬ ë„êµ¬ (v4.5)</h2>

    <div id="dropZone" onclick="document.getElementById('filePicker').click()">
        <p>íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</p>
    </div>

    <div class="config-box">
        <div class="mode-area">
            <span class="mode-label">ğŸ“‚ íŒŒì¼ ì²˜ë¦¬ ëª¨ë“œ:</span>
            <label class="radio-label"><input type="radio" name="proc_mode" value="ì´ì „" checked onchange="onModeChange()"> ì´ì „ ëª¨ë“œ (ë°°ì •ë°˜ ê¸°ì¤€)</label>
            <label class="radio-label"><input type="radio" name="proc_mode" value="ì§„ê¸‰" onchange="onModeChange()"> ì§„ê¸‰ ëª¨ë“œ (ì›ì ë°˜ ê¸°ì¤€)</label>
        </div>
        <div style="margin-bottom:10px; font-size:13px; color:#1a73e8; font-weight:bold;">âš™ï¸ ì¶”ì¶œ ì—´ ì„¤ì • (ìë™ ê°ì§€ / ìˆ˜ë™ ìˆ˜ì • ê°€ëŠ¥)</div>
        <div class="config-grid">
            <div class="config-item"><label>ì„±ëª…</label><input type="number" id="idx_name" value="3" oninput="reprocess()"></div>
            <div class="config-item"><label>ì´ì „í•™ë…„</label><input type="number" id="idx_p_g" value="12" oninput="reprocess()"></div>
            <div class="config-item"><label>ì´ì „ë°˜</label><input type="number" id="idx_p_c" value="13" oninput="reprocess()"></div>
            <div class="config-item"><label>ì´ì „ë²ˆí˜¸</label><input type="number" id="idx_p_n" value="15" oninput="reprocess()"></div>
            <div class="config-item"><label>í˜„ì¬í•™ë…„</label><input type="number" id="idx_c_g" value="0" oninput="reprocess()"></div>
            <div class="config-item"><label>í˜„ì¬ë°˜</label><input type="number" id="idx_c_c" value="1" oninput="reprocess()"></div>
            <div class="config-item"><label>í˜„ì¬ë²ˆí˜¸</label><input type="number" id="idx_c_n" value="2" oninput="reprocess()"></div>
        </div>
    </div>

    <div class="btn-area">
        <input type="file" id="filePicker" accept=".csv, .xlsx, .xls" style="display:none;">
        <button class="btn-red" onclick="resetAll()">ì´ˆê¸°í™”</button>
        <button class="btn-green" style="margin-left: auto;" onclick="exportToCSV()">ê²°ê³¼ ì €ì¥í•˜ê¸° (CSV)</button>
        <div id="status">íŒŒì¼ì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>

    <div class="tabs">
        <div id="tab1" class="tab active" onclick="switchTab(1)">ì •ìƒ ë°ì´í„°</div>
        <div id="tab2" class="tab" onclick="switchTab(2)">ì˜ˆì™¸ ë°ì´í„° (ê²°ì¸¡ì¹˜)</div>
        <div id="tab3" class="tab" onclick="switchTab(3)">ë¶ˆëŸ¬ì˜¨ ëª¨ë“  ë°ì´í„° (Raw)</div>
    </div>

    <div id="view1" class="tab-content active">
        <table id="tableValid">
            <thead><tr><th>ì„±ëª…</th><th>ì´ì „í•™ë…„</th><th>ì´ì „ë°˜</th><th>ì´ì „ë²ˆí˜¸</th><th>í˜„ì¬í•™ë…„</th><th>í˜„ì¬ë°˜</th><th>í˜„ì¬ë²ˆí˜¸</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="view2" class="tab-content">
        <table id="tableException">
            <thead><tr><th>ì„±ëª…</th><th>ì´ì „í•™ë…„</th><th>ì´ì „ë°˜</th><th>ì´ì „ë²ˆí˜¸</th><th>í˜„ì¬í•™ë…„</th><th>í˜„ì¬ë°˜</th><th>í˜„ì¬ë²ˆí˜¸</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="view3" class="tab-content">
        <table id="tableRaw">
            <thead></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    let originalRawData = []; 
    let finalValid = [];
    let finalException = [];

    const dropZone = document.getElementById('dropZone');
    const filePicker = document.getElementById('filePicker');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }));
    ['dragenter', 'dragover'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.add('dragover')));
    ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, () => dropZone.classList.remove('dragover')));
    dropZone.addEventListener('drop', e => { if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files[0]); });
    filePicker.addEventListener('change', e => { if (e.target.files.length) handleFiles(e.target.files[0]); });

    function handleFiles(file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            try {
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                originalRawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1, defval: ""});
                
                autoDetectAndMap(originalRawData);
                processData(originalRawData);
            } catch (err) { alert("íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        };
        reader.readAsArrayBuffer(file);
    }

    function onModeChange() {
        if (originalRawData.length > 0) {
            detectMappingWithMode(originalRawData);
            processData(originalRawData);
        }
    }

    function autoDetectAndMap(rows) {
        let detectedMode = "ì´ì „";
        for (let r of rows) {
            const str = r.join("|");
            if (str.includes("ì§„ê¸‰")) { detectedMode = "ì§„ê¸‰"; break; }
        }
        document.querySelector(`input[name="proc_mode"][value="${detectedMode}"]`).checked = true;
        detectMappingWithMode(rows);
    }

    function detectMappingWithMode(rows) {
        let headerRowIdx = -1;
        let isMultiColumnHeader = false;

        // í—¤ë” í–‰ íƒìƒ‰ (ì„±ëª…ê³¼ í•™ë…„ì´ ë™ì‹œì— ìˆëŠ” í–‰)
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i].map(c => String(c).trim());
            if (row.includes("ì„±ëª…") && row.includes("í•™ë…„")) {
                headerRowIdx = i;
                if (row.filter(item => item === "í•™ë…„").length >= 2) isMultiColumnHeader = true;
                break;
            }
        }

        // ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ ë””í´íŠ¸ ì ìš©
        if (headerRowIdx === -1) {
            applyDefaultSettings();
            document.getElementById('status').innerHTML = `<span style="color:#d93025">âš ï¸ í—¤ë” ê°ì§€ ì‹¤íŒ¨. ë””í´íŠ¸ ì„¤ì • ì ìš©.</span>`;
            return;
        }

        const headerRow = rows[headerRowIdx].map(c => String(c).trim());
        const currentMode = document.querySelector('input[name="proc_mode"]:checked').value;
        const nameIdx = headerRow.indexOf("ì„±ëª…");
        if (nameIdx !== -1) document.getElementById('idx_name').value = nameIdx;

        if (isMultiColumnHeader) {
            const firstGrade = headerRow.indexOf("í•™ë…„");
            const firstClass = headerRow.indexOf("ë°˜");
            const firstNum = headerRow.indexOf("ë²ˆí˜¸");
            const lastGrade = headerRow.lastIndexOf("í•™ë…„");
            const lastClass = headerRow.lastIndexOf("ë°˜");
            const lastNum = headerRow.lastIndexOf("ë²ˆí˜¸");

            if (currentMode === "ì§„ê¸‰") {
                document.getElementById('idx_c_g').value = firstGrade;
                document.getElementById('idx_c_c').value = firstClass;
                document.getElementById('idx_c_n').value = firstNum;
                document.getElementById('idx_p_g').value = lastGrade;
                document.getElementById('idx_p_c').value = lastClass;
                document.getElementById('idx_p_n').value = lastNum;
            } else {
                document.getElementById('idx_p_g').value = firstGrade;
                document.getElementById('idx_p_c').value = firstClass;
                document.getElementById('idx_p_n').value = firstNum;
                document.getElementById('idx_c_g').value = lastGrade;
                document.getElementById('idx_c_c').value = lastClass;
                document.getElementById('idx_c_n').value = lastNum;
            }
        } else {
            const gIdx = headerRow.indexOf("í•™ë…„");
            const cIdx = headerRow.indexOf("ë°˜");
            const nIdx = headerRow.indexOf("ë²ˆí˜¸");

            if (currentMode === "ì§„ê¸‰") {
                if (gIdx !== -1) document.getElementById('idx_p_g').value = gIdx;
                if (cIdx !== -1) document.getElementById('idx_p_c').value = cIdx;
                if (nIdx !== -1) document.getElementById('idx_p_n').value = nIdx;
                findInEmptyRows(rows, "í˜„ì¬");
            } else {
                if (gIdx !== -1) document.getElementById('idx_c_g').value = gIdx;
                if (cIdx !== -1) document.getElementById('idx_c_c').value = cIdx;
                if (nIdx !== -1) document.getElementById('idx_c_n').value = nIdx;
                findInEmptyRows(rows, "ì´ì „");
            }
        }
        document.querySelectorAll('.config-item input').forEach(el => { el.classList.remove('default-applied'); el.classList.add('auto-detected'); });
        document.getElementById('status').innerHTML = `<span style="color:#1a73e8">[${currentMode} ëª¨ë“œ] í—¤ë”ë¥¼ ê°ì§€í•˜ì—¬ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.</span>`;
    }

    function applyDefaultSettings() {
        document.querySelector('input[name="proc_mode"][value="ì´ì „"]').checked = true;
        document.getElementById('idx_name').value = 3;
        document.getElementById('idx_p_g').value = 12;
        document.getElementById('idx_p_c').value = 13;
        document.getElementById('idx_p_n').value = 15;
        document.getElementById('idx_c_g').value = 0;
        document.getElementById('idx_c_c').value = 1;
        document.getElementById('idx_c_n').value = 2;
        document.querySelectorAll('.config-item input').forEach(el => { el.classList.remove('auto-detected'); el.classList.add('default-applied'); });
    }

    function findInEmptyRows(rows, targetType) {
        let gFound=false, cFound=false, nFound=false;
        for (let r of rows) {
            const row = r.map(c => String(c).trim());
            if (row[0] === "") {
                if (!gFound && row.includes("í•™ë…„")) {
                    const idx = row.indexOf("í•™ë…„");
                    if (targetType === "í˜„ì¬") document.getElementById('idx_c_g').value = idx; else document.getElementById('idx_p_g').value = idx;
                    gFound = true;
                }
                if (!cFound && row.includes("ë°˜")) {
                    const idx = row.indexOf("ë°˜");
                    if (targetType === "í˜„ì¬") document.getElementById('idx_c_c').value = idx; else document.getElementById('idx_p_c').value = idx;
                    cFound = true;
                }
                if (!nFound && row.includes("ë²ˆí˜¸")) {
                    const idx = row.indexOf("ë²ˆí˜¸");
                    if (targetType === "í˜„ì¬") document.getElementById('idx_c_n').value = idx; else document.getElementById('idx_p_n').value = idx;
                    nFound = true;
                }
            }
            if (gFound && cFound && nFound) break;
        }
    }

    function reprocess() { if (originalRawData.length > 0) processData(originalRawData); }

    function processData(allRows) {
        finalValid = []; finalException = [];
        const mapping = {
            name: parseInt(document.getElementById('idx_name').value),
            p_g:  parseInt(document.getElementById('idx_p_g').value),
            p_c:  parseInt(document.getElementById('idx_p_c').value),
            p_n:  parseInt(document.getElementById('idx_p_n').value),
            c_g:  parseInt(document.getElementById('idx_c_g').value),
            c_c:  parseInt(document.getElementById('idx_c_c').value),
            c_n:  parseInt(document.getElementById('idx_c_n').value)
        };

        const gradeRegex = /^(\d+.*|\d+)$/;

        allRows.forEach(row => {
            const cleanRow = row.map(cell => cell !== null && cell !== undefined ? String(cell).trim() : "");
            const gradeVal = cleanRow[mapping.c_g];

            if (gradeVal && gradeVal !== "í•™ë…„" && gradeRegex.test(gradeVal)) {
                let currentNum = cleanRow[mapping.c_n];
                if (currentNum === "0" || currentNum === "0.0") currentNum = "";
                
                const extracted = [
                    cleanRow[mapping.name], cleanRow[mapping.p_g], cleanRow[mapping.p_c], cleanRow[mapping.p_n], 
                    cleanRow[mapping.c_g], cleanRow[mapping.c_c], currentNum
                ];

                const isInvalid = [extracted[0], extracted[1], extracted[2], extracted[4], extracted[5]].some(v => v === "" || v.toLowerCase() === "nan");
                if (isInvalid) finalException.push(extracted);
                else finalValid.push(extracted);
            }
        });
        renderUI();
        renderRawTable(); // ì›ë³¸ ë°ì´í„° íƒ­ ë Œë”ë§
    }

    function resetAll() {
        if (!confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        originalRawData = []; finalValid = []; finalException = [];
        filePicker.value = ""; document.getElementById('status').innerHTML = "íŒŒì¼ì„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...";
        document.querySelectorAll('.config-item input').forEach(el => { el.classList.remove('auto-detected'); el.classList.remove('default-applied'); });
        renderUI();
        renderRawTable();
    }

    function renderUI() {
        fillTable('tableValid', finalValid); fillTable('tableException', finalException);
        if (originalRawData.length > 0) document.getElementById('status').innerHTML += ` | ì •ìƒ <b>${finalValid.length}</b>ê±´ / ì˜ˆì™¸ <b>${finalException.length}</b>ê±´`;
    }

    // ì›ë³¸ ë°ì´í„°(Raw) ë Œë”ë§ í•¨ìˆ˜
    function renderRawTable() {
        const table = document.getElementById('tableRaw');
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = ""; tbody.innerHTML = "";

        if (originalRawData.length === 0) return;

        // ìµœëŒ€ ì—´ ê°œìˆ˜ ê³„ì‚°
        let maxCol = 0;
        originalRawData.forEach(r => { if (r.length > maxCol) maxCol = r.length; });

        // í—¤ë” ìƒì„± (0 A, 1 B, 2 C ...)
        let headerHTML = "<tr><th>í–‰\\ì—´</th>";
        for (let i = 0; i < maxCol; i++) {
            headerHTML += `<th>${i} (${getColName(i)})</th>`;
        }
        headerHTML += "</tr>";
        thead.innerHTML = headerHTML;

        // ë³¸ë¬¸ ìƒì„± (ëŒ€ëŸ‰ ë°ì´í„° ì„±ëŠ¥ ê³ ë ¤í•˜ì—¬ ìƒìœ„ 500ê°œë§Œ í‘œì‹œí•˜ê±°ë‚˜ ì „ì²´ í‘œì‹œ)
        // ì—¬ê¸°ì„œëŠ” ì „ì²´ í‘œì‹œ
        originalRawData.forEach((row, rIdx) => {
            let tr = document.createElement('tr');
            let th = document.createElement('td');
            th.textContent = rIdx; 
            tr.appendChild(th);

            for (let cIdx = 0; cIdx < maxCol; cIdx++) {
                let td = document.createElement('td');
                td.textContent = row[cIdx] !== undefined ? row[cIdx] : "";
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        });
    }

    // ì—‘ì…€ ì»¬ëŸ¼ ëª…ì¹­ ë³€í™˜ (0->A, 25->Z, 26->AA)
    function getColName(n) {
        let s = "";
        while (n >= 0) {
            s = String.fromCharCode(n % 26 + 65) + s;
            n = Math.floor(n / 26) - 1;
        }
        return s;
    }

    function fillTable(id, data) {
        const tbody = document.getElementById(id).querySelector('tbody');
        tbody.innerHTML = data.length === 0 ? '<tr><td colspan="7" class="empty-msg">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>' : "";
        data.forEach(rowData => {
            const tr = document.createElement('tr');
            rowData.forEach(text => { const td = document.createElement('td'); td.innerText = text; tr.appendChild(td); });
            tbody.appendChild(tr);
        });
    }

    function switchTab(idx) {
        document.querySelectorAll('.tab, .tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab' + idx).classList.add('active');
        document.getElementById('view' + idx).classList.add('active');
    }

    function exportToCSV() {
        if (finalValid.length === 0) return alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        const header = ["ì„±ëª…", "í•™ë…„", "ë°˜", "ë²ˆí˜¸", "í•™ë…„", "ë°˜", "ë²ˆí˜¸"];
        const rows = [header, ...finalValid];
        const csvString = rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(",")).join("\r\n");
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "ë°˜í¸ì„±ê²°ê³¼.csv";
        link.click();
    }
</script>

</body>
</html>
